<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuerpo Musical con IA</title>
    <!-- Carga de Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de p5.js y su librería de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <!-- Carga de ml5.js -->
    <script src="https://unpkg.com/ml5@0.7.1/dist/ml5.min.js"></script>
    <style>
        /* Estilos para asegurar que la app se vea bien */
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-4xl md:text-5xl font-bold text-cyan-400">Cuerpo Musical con IA</h1>
        <p id="status" class="mt-2 text-lg text-gray-300">Cargando modelos de IA... Por favor, espera.</p>
        <p id="instructions" class="mt-2 text-md text-gray-400 hidden">¡Modelo cargado! Mueve tus muñecas para crear música.</p>
        <p id="audio-prompt" class="mt-4 text-yellow-400 font-semibold text-lg animate-pulse">Haz clic en la pantalla para activar el sonido.</p>
    </div>

    <!-- El contenedor para el canvas de p5.js -->
    <div id="canvas-container" class="w-full max-w-2xl aspect-video bg-gray-800 rounded-xl shadow-lg"></div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-center text-gray-500 text-sm">
        <div>
            <p class="font-bold text-cyan-400">Mano Derecha</p>
            <p>Vertical ↕ = Tono</p>
            <p>Horizontal ↔ = Volumen</p>
        </div>
        <div>
            <p class="font-bold text-pink-400">Mano Izquierda</p>
            <p>Vertical ↕ = Frecuencia del Filtro</p>
            <p>Horizontal ↔ = Resonancia del Filtro</p>
        </div>
    </div>

    <script>
        // Declaración de variables globales
        let video;
        let poseNet;
        let poses = [];
        let osc, envelope, filter; // Oscilador, envolvente y filtro para el sonido
        
        let isAudioEnabled = false; // Controla si el audio ha sido activado por el usuario

        // --- Función de configuración de p5.js ---
        // Se ejecuta una sola vez al cargar la página
        function setup() {
            const canvasContainer = document.getElementById('canvas-container');
            const canvas = createCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            canvas.parent('canvas-container');

            // --- Configuración del Sonido ---
            envelope = new p5.Envelope();
            envelope.setADSR(0.01, 0.1, 0.5, 0.4);
            envelope.setRange(1, 0);

            osc = new p5.Oscillator('sawtooth'); // Cambiado a 'sawtooth' para que el filtro sea más notorio
            osc.amp(envelope);
            
            filter = new p5.LowPass(); // Creamos el filtro de paso bajo
            osc.disconnect(); // Desconectamos el oscilador de la salida principal
            osc.connect(filter); // Conectamos el oscilador al filtro
            
            osc.start();
            osc.freq(440);

            // --- Configuración de la Cámara ---
            video = createCapture(VIDEO);
            video.size(width, height);
            video.hide();

            // --- Carga del modelo PoseNet ---
            poseNet = ml5.poseNet(video, modelReady);
            poseNet.on('pose', (results) => {
                poses = results;
            });
        }

        // --- Callback para cuando el modelo está listo ---
        function modelReady() {
            console.log('¡Modelo PoseNet cargado!');
            document.getElementById('status').innerText = '¡Modelo listo!';
            document.getElementById('instructions').classList.remove('hidden');
        }

        // --- Activar el audio con un clic ---
        function mousePressed() {
            if (!isAudioEnabled && (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height)) {
                getAudioContext().resume().then(() => {
                    console.log('Contexto de audio reanudado.');
                    isAudioEnabled = true;
                    document.getElementById('audio-prompt').classList.add('hidden');
                });
            }
        }

        // --- Función de dibujo de p5.js (bucle principal) ---
        function draw() {
            // Dibujamos el video espejado en el canvas
            push();
            translate(width, 0);
            scale(-1, 1);
            image(video, 0, 0, width, height);
            pop();

            // Dibujamos el esqueleto y los puntos
            drawKeypoints();
            drawSkeleton();

            // --- Lógica para controlar el sonido ---
            if (poses.length > 0 && isAudioEnabled) {
                const pose = poses[0].pose;
                const rightWrist = pose.keypoints.find(k => k.part === 'rightWrist');
                const leftWrist = pose.keypoints.find(k => k.part === 'leftWrist'); // Buscamos la muñeca izquierda

                // --- Control de la mano derecha (Tono y Volumen) ---
                if (rightWrist && rightWrist.score > 0.2) {
                    let freq = map(rightWrist.position.y, 0, height, 600, 100);
                    let amp = map(rightWrist.position.x, 0, width, 0.05, 0.5);
                    osc.freq(freq, 0.1);
                    envelope.setRange(amp, 0);
                    envelope.play(osc, 0, 0.1);
                }

                // --- Control de la mano izquierda (Filtro) ---
                if (leftWrist && leftWrist.score > 0.2) {
                    // Mapeamos Y a la frecuencia de corte del filtro (más arriba = más brillante)
                    let filterFreq = map(leftWrist.position.y, 0, height, 5000, 100);
                    // Mapeamos X a la resonancia del filtro (más a la derecha = más resonante)
                    let filterRes = map(leftWrist.position.x, 0, width, 15, 5);
                    filter.freq(filterFreq, 0.1);
                    filter.res(filterRes, 0.1);
                }
            }
        }
        
        // --- Dibuja los puntos clave (articulaciones) ---
        function drawKeypoints() {
            for (let i = 0; i < poses.length; i++) {
                const pose = poses[i].pose;
                for (let j = 0; j < pose.keypoints.length; j++) {
                    const keypoint = pose.keypoints[j];
                    if (keypoint.score > 0.2) {
                        // Coloreamos la muñeca izquierda de rosa para distinguirla
                        if (keypoint.part === 'leftWrist') {
                            fill(236, 72, 153); // Color rosa
                        } else {
                            fill(45, 212, 191); // Color cian
                        }
                        noStroke();
                        const mirroredX = width - keypoint.position.x;
                        ellipse(mirroredX, keypoint.position.y, 12, 12);
                    }
                }
            }
        }

        // --- Dibuja el esqueleto ---
        function drawSkeleton() {
            for (let i = 0; i < poses.length; i++) {
                const skeleton = poses[i].skeleton;
                for (let j = 0; j < skeleton.length; j++) {
                    const partA = skeleton[j][0];
                    const partB = skeleton[j][1];
                    stroke(255, 255, 255, 150);
                    strokeWeight(3);
                    const mirroredAx = width - partA.position.x;
                    const mirroredBx = width - partB.position.x;
                    line(mirroredAx, partA.position.y, mirroredBx, partB.position.y);
                }
            }
        }

        // Ajusta el canvas si la ventana cambia de tamaño
        function windowResized() {
            const canvasContainer = document.getElementById('canvas-container');
            resizeCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            video.size(width, height);
        }

    </script>
</body>
</html>
